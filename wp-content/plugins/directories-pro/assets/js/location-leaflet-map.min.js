"use strict";var _createClass=function(){function o(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,r){return e&&o(t.prototype,e),r&&o(t,r),t}}(),_get=function t(e,r,o){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,r);if(void 0===i){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,r,o)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(o):void 0};function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}!function(s){function i(t,e){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,e)),o={zoomControl:!1,zoom:r.options.default_zoom,scrollWheelZoom:r.options.scrollwheel,center:L.latLng(r.options.default_location.lat,r.options.default_location.lng),layers:[L.tileLayer(r.options.use_custom_tile_url&&r.options.tile_url?r.options.tile_url:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{id:"osm",attribution:!(!r.options.add_attribution&&void 0!==r.options.add_attribution)&&(r.options.attribution||'&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors')})],gestureHandling:!0};return r.map=L.map(r.$map.get(0),o),L.control.zoom({position:"bottomright"}).addTo(r.map),r.currentCircle=null,r.markerCluster=null,r.options.marker_clusters&&(r.markerCluster=L.markerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0})),r.options.infobox&&r.map.on("resize movestart zoomstart",function(t){r.getPopover().sabaiPopover("hide"),r.currentMarker=null}),r.map.on("click",function(t){r.container.trigger("map_clicked.sabai",{map:r.map,latlng:[t.latlng.lat,t.latlng.wrap().lng]})}),r.map.on("zoomend",function(t){r.container.trigger("map_zoom_changed.sabai",{map:r.map,zoom:r.map.getZoom()})}),r.map.on("dragend",function(t){r.container.trigger("map_dragend.sabai",{map:r.map})}),r.map.on("mousedown",function(t){r.container.trigger("map_mousedown.sabai",{map:r.map})}),r}DRTS.Location=DRTS.Location||{},DRTS.Location.leaflet=DRTS.Location.leaflet||{},DRTS.Location.leaflet.map=(_inherits(i,DRTS.Map.map),_createClass(i,[{key:"clearMarkers",value:function(){for(var t in this.markers)this.markers.hasOwnProperty(t)&&this.map.removeLayer(this.markers[t]);return this.markerCluster&&this.markerCluster.clearLayers(),_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"clearMarkers",this).call(this)}},{key:"addMarker",value:function(t){if(!t.lat||!t.lng)return this;var e=void 0,r=void 0,o={riseOnHover:!0};return this.options.marker_custom&&(r=t.icon?DRTS.Location.leaflet.map.divIcon({html:t.icon.url?s("<img/>").attr("src",t.icon.url)[0].outerHTML:null,icon:t.icon.icon||this.options.marker_icon,icon_color:t.icon.icon_color||this.options.marker_icon_color,size:t.icon.size||this.options.marker_size,color:t.icon.color||this.options.marker_color||"#fff",full:!!t.icon.is_full}):DRTS.Location.leaflet.map.divIcon({icon:this.options.marker_icon||"",icon_color:this.options.marker_icon_color,size:this.options.marker_size,color:this.options.marker_color||"#fff"}),o.icon=r),(e=L.marker([t.lat,t.lng],o))._id=t.entity_id+"-"+t.index,e._content=t.content,e._entity_id=t.entity_id,e._key=t.index,this.markers[e._id]=e,this}},{key:"getMarkerLatlng",value:function(t){if(null==t){var e=Object.keys(this.markers)[0];t=this.markers[e]}var r=t.getLatLng();return[r.lat,r.lng]}},{key:"getMarkerContent",value:function(t){return t._content}},{key:"getMarkerPosition",value:function(t){return this.map.latLngToContainerPoint(t.getLatLng())}},{key:"getMarkerHeight",value:function(t){return t._marker_height}},{key:"getMarkerEntityId",value:function(t){return t._entity_id}},{key:"getMarkerKey",value:function(t){return t._key}},{key:"draw",value:function(t){var e=this;if(t=t||{},this.currentMarker=null,this.currentCircle&&this.currentCircle.remove(),0<Object.keys(this.markers).length){var r=void 0,o=[];for(var i in r=void 0===t.fit_bounds?this.options.fit_bounds:t.fit_bounds,Object.keys(this.markers).length<=1&&(r=!1),this.markers)if(this.markers.hasOwnProperty(i)){if(this.markerCluster||this.markers[i].addTo(this.map),r){var n=this.markers[i].getLatLng();o.push(n),t.center&&o.push([2*t.center[0]-n.lat,2*t.center[1]-n.lng])}this.markers[i].on(this.options.infobox_event,function(e,r){return function(t){e.clickMarker(r)}}(this,this.markers[i]))}if(this.markerCluster&&(this.markerCluster.addLayers(Object.values(this.markers)),this.map.addLayer(this.markerCluster)),r){var a=void 0===t.fit_bounds_padding?this.options.fit_bounds_padding:t.fit_bounds_padding;this.map.fitBounds(o,{padding:[a,a]})}else t.center||(this.options.center_default?t.center=[this.options.default_location.lat,this.options.default_location.lng]:t.center=this.markers[Object.keys(this.markers)[0]].getLatLng()),setTimeout(function(){e.map.invalidateSize()},500)}return t.center&&(this.map.setView(t.center,t.zoom||this.options.default_zoom||10),t.circle&&(this.currentCircle=L.circle(t.center,t.circle.radius,{color:t.circle.stroke_color||"#99f",opacity:.8,weight:1,fill:!0,fillColor:t.circle.fill_color||"#99f",fillOpacity:.3}).addTo(this.map))),s(DRTS).trigger("map_drawn.sabai",{map:this}),this}},{key:"clickMarker",value:function(t,e){var r=this;if(this.currentMarker){if(this.currentMarker===t._id)return this.showMarkerContent(t,e),this.currentMarker=t._id,void(e||this.container.trigger("marker_click.sabai",{map:this,marker:t}));this.markers[this.currentMarker].setZIndexOffset(0)}return t.setZIndexOffset(2e3),e&&this.markerCluster&&(this.currentMarker&&(this.map.removeLayer(this.markers[this.currentMarker]),this.markerCluster.addLayer(this.markers[this.currentMarker])),this.markerCluster.removeLayer(t),t.addTo(this.map)),this.map.getBounds()&&!this.map.getBounds().contains(t.getLatLng())?(this.map.panTo(t.getLatLng(),{duration:.25}),setTimeout(function(){r.showMarkerContent(t)},300)):this.showMarkerContent(t,e),this.currentMarker=t._id,e||this.container.trigger("marker_click.sabai",{map:this,marker:t}),this}},{key:"animateMarker",value:function(t){t.bounce({duration:800,height:50})}},{key:"onResized",value:function(){return this.map.invalidateSize(),this}},{key:"getZoom",value:function(){return this.map.getZoom()}},{key:"getSouthWest",value:function(){var t=this.map.getBounds();return[t.getSouthWest().lat,t.getSouthWest().lng]}},{key:"getNorthEast",value:function(){var t=this.map.getBounds();return[t.getNorthEast().lat,t.getNorthEast().lng]}}]),i),DRTS.Location.leaflet.map.divIcon=function(t){var e=document.createElement("div"),r="drts-map-marker";if(t.full)r+=" drts-map-marker-full",e.innerHTML=t.html;else{var o=t.size||39,i=document.createElement("div");t.color&&(e.style.backgroundColor=e.style.color=i.style.borderColor=t.color),e.style.width=o+"px",e.style.height=o+"px",e.style.marginTop="-"+(o*Math.sqrt(2)-DRTS.Map.markerHeight(o))+"px",t.html?i.innerHTML=t.html:(t.icon?i.innerHTML='<i class="'+t.icon+'"></i>':i.style.boxShadow="none",t.icon_color&&(i.style.backgroundColor=t.icon_color)),e.appendChild(i)}return e.className=r,t.data&&(e.dataset=t.data),L.divIcon({html:e.outerHTML,iconSize:[0,0]})},DRTS.Map.api.getMap=function(t,e){return new DRTS.Location.leaflet.map(t,e)}}(jQuery);