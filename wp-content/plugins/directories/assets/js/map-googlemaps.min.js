"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,o){return t&&r(e.prototype,t),o&&r(e,o),e}}(),_get=function e(t,o,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,o);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,o,r)}if("value"in i)return i.value;var n=i.get;return void 0!==n?n.call(r):void 0};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}!function(p){function c(e,t){_classCallCheck(this,c);var o=_possibleConstructorReturn(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,e,t));o.markerClusterer=null,o.overlay=null,o.currentCircle=null;var r=[];for(var i in google.maps.MapTypeId)r.push(google.maps.MapTypeId[i]);var s={mapTypeId:-1!==p.inArray(o.options.type,r)?o.options.type:google.maps.MapTypeId.ROADMAP,mapTypeControl:!(void 0!==o.options.map_type_control&&!o.options.map_type_control),zoomControl:!0,streetViewControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:o.options.fullscreen_control||!1,center:new google.maps.LatLng(o.options.default_location.lat,o.options.default_location.lng),scrollwheel:o.options.scrollwheel,styles:o.options.style&&DRTS.Map.googlemaps.styles[o.options.style]?DRTS.Map.googlemaps.styles[o.options.style]:[{featureType:"poi",stylers:[{visibility:"off"}]}],zoom:o.options.default_zoom};if(s.mapTypeControl&&(s.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,mapTypeIds:r,position:google.maps.ControlPosition.TOP_RIGHT}),o.map=new google.maps.Map(o.$map.get(0),s),o.options.marker_clusters){var n=o.options.marker_cluster_color||null,a={render:function(e,t){var o=e.count,r=e.position,i=n||(o>Math.max(10,t.clusters.markers.mean)?"#ff0000":"#0000ff"),s=window.btoa('\n  <svg fill="'+i+'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240">\n    <circle cx="120" cy="120" opacity=".6" r="70" />\n    <circle cx="120" cy="120" opacity=".3" r="90" />\n    <circle cx="120" cy="120" opacity=".2" r="110" />\n  </svg>');return new google.maps.Marker({position:r,icon:{url:"data:image/svg+xml;base64,"+s,scaledSize:new google.maps.Size(45,45)},label:{text:String(o),color:"rgba(255,255,255,0.9)",fontSize:"12px"},title:"Cluster of "+o+" markers",zIndex:Number(google.maps.Marker.MAX_ZINDEX)+o})}};o.markerClusterer=new markerClusterer.MarkerClusterer({map:o.map,renderer:a})}if(o.options.infobox){o.getPopover(),o.getOverlay();var l=function(){o.getPopover().sabaiPopover("hide"),o.currentMarker=null};google.maps.event.addListener(o.map,"dragstart",l),google.maps.event.addListener(o.map,"zoom_changed",l),p(window).on("resize",l)}return o.map.getStreetView().setOptions({disableDefaultUI:!0,enableCloseButton:!1,zoomControl:!0,visible:!1}),google.maps.event.addListener(o.map,"click",function(e){o.container.trigger("map_clicked.sabai",{map:o.map,latlng:[e.latLng.lat(),e.latLng.lng()]})}),google.maps.event.addListener(o.map,"zoom_changed",function(e){o.container.trigger("map_zoom_changed.sabai",{map:o.map,zoom:o.map.getZoom()})}),google.maps.event.addListener(o.map,"dragend",function(e){o.container.trigger("map_dragend.sabai",{map:o.map})}),google.maps.event.addListener(o.map,"mousedown",function(e){o.container.trigger("map_mousedown.sabai",{map:o.map,latlng:[e.latLng.lat(),e.latLng.lng()]})}),o}DRTS.Map.googlemaps={styles:{}},DRTS.Map.googlemaps.map=(_inherits(c,DRTS.Map.map),_createClass(c,[{key:"clearMarkers",value:function(){for(var e in this.markers)this.markers.hasOwnProperty(e)&&this.markers[e].setMap(null);return this.markerClusterer&&this.markerClusterer.clearMarkers(),_get(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"clearMarkers",this).call(this)}},{key:"addMarker",value:function(e){if(!e.lat||!e.lng)return this;var t=void 0,o=void 0;if(this.options.marker_custom)if(e.icon){var r={html:e.icon.url?p("<img/>").attr("src",e.icon.url)[0].outerHTML:null,icon:e.icon.icon||this.options.marker_icon,icon_color:e.icon.icon_color||this.options.marker_icon_color,full:!!e.icon.is_full,size:e.icon.size||this.options.marker_size,color:e.icon.color||this.options.marker_color||"#fff",event:this.options.infobox_event};t=new DRTS.Map.googlemaps.map.marker(r)}else void 0===o&&(o={icon:this.options.marker_icon||"",icon_color:this.options.marker_icon_color,size:this.options.marker_size,color:this.options.marker_color||"#fff",event:this.options.infobox_event}),t=new DRTS.Map.googlemaps.map.marker(o);else t=new google.maps.Marker;return t.setPosition(new google.maps.LatLng(e.lat,e.lng)),t.set("id",e.entity_id+"-"+e.index),t.set("content",e.content),t.set("entity_id",e.entity_id),t.set("key",e.index),this.markers[t.get("id")]=t,this}},{key:"getMarkerLatlng",value:function(e){if(null==e){var t=Object.keys(this.markers)[0];e=this.markers[t]}var o=e.getPosition();return[o.lat(),o.lng()]}},{key:"getMarkerContent",value:function(e){return e.get("content")}},{key:"getMarkerPosition",value:function(e){if(this.getOverlay()&&this.getOverlay().getProjection())return this.getOverlay().getProjection().fromLatLngToContainerPixel(e.getPosition())}},{key:"getMarkerHeight",value:function(e){return e.get("marker_height")}},{key:"getMarkerEntityId",value:function(e){return e.get("entity_id")}},{key:"getMarkerKey",value:function(e){return e.get("key")}},{key:"draw",value:function(e){var o=this;if(e=e||{},this.currentMarker=null,this.currentCircle&&this.currentCircle.setMap(null),0<Object.keys(this.markers).length){var t=void 0;for(var r in(void 0===e.fit_bounds?this.options.fit_bounds:e.fit_bounds)&&1<Object.keys(this.markers).length&&(t=new google.maps.LatLngBounds),this.markers)if(this.markers.hasOwnProperty(r)){if(this.markerClusterer||this.markers[r].setMap(this.map),t){var i=this.markers[r].getPosition();t.extend(i),e.center&&t.extend(new google.maps.LatLng(2*e.center[0]-i.lat(),2*e.center[1]-i.lng()))}google.maps.event.addListener(this.markers[r],this.options.infobox_event,function(t){return function(e){o.clickMarker(t)}}(this.markers[r])),Object.keys(this.markers).length<=100&&(this.markers[r].setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(e){return function(){e.setAnimation(null)}}(this.markers[r]),500))}if(this.markerClusterer&&this.markerClusterer.addMarkers(Object.values(this.markers)),t)this.map.fitBounds(t,void 0===e.fit_bounds_padding?this.options.fit_bounds_padding:e.fit_bounds_padding);else if(!e.center)if(this.options.center_default)e.center=[this.options.default_location.lat,this.options.default_location.lng];else{var s=this.markers[Object.keys(this.markers)[0]].getPosition();e.center=[s.lat(),s.lng()]}e.street_view&&this.drawStreetView("object"===_typeof(e.street_view)?e.street_view:this.markers[Object.keys(this.markers)[0]])}if(e.center){var n=new google.maps.LatLng(e.center[0],e.center[1]);this.map.setZoom(e.zoom||this.options.default_zoom||10),this.map.panTo(n),e.circle&&(this.currentCircle=new google.maps.Circle({strokeColor:e.circle.stroke_color||"#99f",strokeOpacity:.8,strokeWeight:1,fillColor:e.circle.fill_color||"#99f",fillOpacity:.3,map:this.map,center:n,radius:e.circle.radius}))}return p(DRTS).trigger("map_drawn.sabai",{map:this}),this}},{key:"clickMarker",value:function(e,t){if(this.currentMarker){if(this.currentMarker.get("id")===e.get("id"))return this.showMarkerContent(e,t),this.currentMarker=e,void(t||this.container.trigger("marker_click.sabai",{map:this,marker:e}));this.currentMarker.setZIndex(0)}e.setZIndex(1),this.markerClusterer&&(this.currentMarker&&this.markerClusterer.addMarker(this.currentMarker),this.markerClusterer.removeMarker(e),e.setMap(this.map)),this.map.getBounds()&&!this.map.getBounds().contains(e.getPosition())&&this.map.panTo(e.getPosition()),this.markerClusterer?setTimeout(function(){this.showMarkerContent(e,t)}.bind(this),100):this.showMarkerContent(e,t),this.currentMarker=e,t||this.container.trigger("marker_click.sabai",{map:this,marker:e})}},{key:"animateMarker",value:function(e){e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1e3)}},{key:"onResized",value:function(){return this.getOverlay(!0),google.maps.event.trigger(this.map,"resize"),this}},{key:"getZoom",value:function(){return this.map.getZoom()}},{key:"getSouthWest",value:function(){var e=this.map.getBounds();return[e.getSouthWest().lat(),e.getSouthWest().lng()]}},{key:"getNorthEast",value:function(){var e=this.map.getBounds();return[e.getNorthEast().lat(),e.getNorthEast().lng()]}},{key:"getOverlay",value:function(e){return this.overlay&&!e||(this.overlay=new google.maps.OverlayView,this.overlay.draw=function(){},this.overlay.setMap(this.map)),this.overlay}},{key:"drawStreetView",value:function(i,e,s){var t=new google.maps.StreetViewService,n=this.map,a=void 0;return i.setMap&&(i=(a=i).getPosition()),t.getPanorama({location:i,radius:e||50},function(e,t){if(t===google.maps.StreetViewStatus.OK){var o=n.getStreetView();if(o.setPosition(e.location.latLng),a){var r=google.maps.geometry.spherical.computeHeading(e.location.latLng,i);o.setPov({heading:r,pitch:0,zoom:1}),a.setMap(o)}o.setVisible(!0)}else s&&alert("No street map view is available for this location."),console.log(t)}),this}}]),c),DRTS.Map.api.getMap=function(e,t){return new DRTS.Map.googlemaps.map(e,t)},DRTS.Map.googlemaps.map.marker=function(e){this.options=e||{},this.visible=!0,this.classes=this.options.full?["drts-map-marker drts-map-marker-full"]:["drts-map-marker"],this.div=null},DRTS.Map.googlemaps.map.marker.prototype=new google.maps.OverlayView,DRTS.Map.googlemaps.map.marker.prototype.onAdd=function(){var t=this;if(this.div=document.createElement("div"),this.div.className=this.classes.join(" "),this.options.full)this.div.innerHTML=this.options.html;else{var e=this.options.size||38,o=document.createElement("div");this.div.style.width=e+"px",this.div.style.height=e+"px",this.div.style.marginTop="-"+(e*Math.sqrt(2)-DRTS.Map.markerHeight(e))+"px",this.options.color&&(this.div.style.backgroundColor=this.div.style.color=o.style.borderColor=this.options.color),this.options.html?o.innerHTML=this.options.html:(this.options.icon?o.innerHTML='<i class="'+this.options.icon+'"></i>':o.style.boxShadow="none",this.options.icon_color&&(o.style.backgroundColor=this.options.icon_color)),this.div.appendChild(o),this.set("marker_height",DRTS.Map.markerHeight(e))}this.options.data&&(this.div.dataset=this.options.data),this.getPanes().overlayImage.appendChild(this.div);var r=this.options.event;this.div.addEventListener(r,function(e){google.maps.event.trigger(t,r)}),this.setPosition(this.position)},DRTS.Map.googlemaps.map.marker.prototype.draw=function(){this.setPosition(this.position)},DRTS.Map.googlemaps.map.marker.prototype.setPosition=function(e){if(this.position=e,this.div){var t=this.getProjection().fromLatLngToDivPixel(this.position);t&&(this.div.style.left=t.x+"px",this.div.style.top=t.y+"px")}},DRTS.Map.googlemaps.map.marker.prototype.onRemove=function(){this.div&&this.div.parentNode.removeChild(this.div),this.div=null},DRTS.Map.googlemaps.map.marker.prototype.getPosition=function(){return this.position},DRTS.Map.googlemaps.map.marker.prototype.setDraggable=function(e){this.draggable=e},DRTS.Map.googlemaps.map.marker.prototype.getDraggable=function(){this.draggable},DRTS.Map.googlemaps.map.marker.prototype.getVisible=function(){return this.visible},DRTS.Map.googlemaps.map.marker.prototype.setVisible=function(e){this.div&&(this.div.style.display=e?"inline-block":"none"),this.visible=e},DRTS.Map.googlemaps.map.marker.prototype.getDraggable=function(){return this.draggable},DRTS.Map.googlemaps.map.marker.prototype.setDraggable=function(e){this.draggable=e},DRTS.Map.googlemaps.map.marker.prototype.setZIndex=function(e){this.zIndex=e,this.div&&(this.div.style.zIndex=this.zIndex)},DRTS.Map.googlemaps.map.marker.prototype.setAnimation=function(e){var t="drts-map-marker-bounce";if(e)-1===this.classes.indexOf(t)&&this.classes.push(t);else{var o=this.classes.indexOf(t);-1<o&&this.classes.splice(o,1)}this.div&&(this.div.className=this.classes.join(" "))}}(jQuery);